name: Build and Release Latest

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete Existing Latest Release
        run: |
          gh release delete "latest" --yes || echo "No previous 'latest' release to delete."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Existing Latest Tag
        run: |
          git tag -d "latest" || echo "No local 'latest' tag to delete."
          git push origin --delete "latest" || echo "No remote 'latest' tag to delete."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create New Latest Tag
        run: |
          git tag latest
          git push origin latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci --no-audit

      - name: Install Server Dependencies
        run: npm install --prefix server

      - name: Build Application
        run: npm run build

      - name: Create Release Archive
        run: |
          mkdir -p release-package/server
          cp -r dist release-package/
          cp -r server/dist release-package/server/
          cp server/package.json release-package/server/
          cp package.json package-lock.json run.bat run.sh release-package/
          cd release-package
          zip -r ../ani-web.zip .

      - name: Create New Latest Release
        run: |
          gh release create "latest" \
            "ani-web.zip" \
            --title "latest" \
            --notes "Automatically built from the latest commit. Download the 'ani-web.zip' file below and run using run.bat or run.sh." \
            --target ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}